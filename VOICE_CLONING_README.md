# Voice Cloning System - 語音克隆系統

## 概述

語音克隆系統讓用戶錄製自己的聲音作為參考，系統將克隆用戶的音色進行 TTS（文本轉語音）合成，實現個性化的語音輸出。

## 核心特性

- **簡單的聲音克隆**：只需錄製 2-5 秒的參考音頻即可
- **多聲音檔案管理**：支持創建和管理多個不同的聲音克隆
- **語言自動檢測**：自動檢測中文或英文並使用相應的 TTS 模型
- **實時合成**：合成後立即播放系統口述旁白
- **易於使用**：直觀的 GUI 對話框，簡化操作流程

## 使用流程

### 1. 打開語音克隆設定對話框
- 點擊主窗口中的 **"🎙️語音克隆設定"** 按鈕

### 2. 創建新的語音克隆
- 點擊 **"新增克隆"** 按鈕
- 輸入克隆名稱（例如：「我的聲音」）
- 確認建立

### 3. 錄製參考音頻
- 選擇已創建的克隆檔案
- 點擊 **"🎤 開始錄音"** 按鈕
- 自然地說話，建議錄製 2-5 秒的音頻
- 點擊 **"⏹️ 停止錄音"** 按鈕完成錄製
- 系統會自動處理和保存參考音頻

### 4. 設為預設克隆
- 選擇要使用的克隆檔案
- 點擊 **"設為預設"** 按鈕
- 系統將使用此克隆進行所有 TTS 合成

### 5. 開始使用
- 返回主窗口進行圖像或影片生成
- 系統將自動使用克隆的音色進行語音合成

## 技術架構

### 主要模塊

#### `voice_cloning.py`
- **VoiceCloningSystem 類**：語音克隆系統的核心
  - `initialize_tts_model()`：初始化 TTS 模型（優先使用 Coqui XTTS v2，並自動降級至相容模型）
  - `start_recording()` / `stop_recording()`：錄音管理
  - `save_reference_audio()`：保存參考音頻
  - `synthesize_with_cloned_voice()`：使用克隆聲音合成語音

#### `voice_interface.py`（修改）
- `speak(text, wait=True)`：優先使用語音克隆進行合成
- `_generate_cloned_voice(text)`：生成克隆語音檔案
- 自動回退到原有 Azure TTS 系統（如果克隆不可用）

#### `main.py`（修改）
- `open_voice_cloning_dialog()`：打開設定對話框
- `VoiceCloningDialog 類`：GUI 對話框實現

## 文件結構

```
voice_clones/
├── 我的聲音/
│   └── reference_audio.wav    # 參考音頻
├── 我的聲音 2/
│   └── reference_audio.wav
└── profile_settings.json       # 設定檔案
```

## 依賴項

### 新增依賴
```
TTS>=0.22.0  # Coqui TTS 庫
```

### 已有依賴（使用）
- `pyaudio>=0.2.11`：音頻錄製
- `librosa>=0.10.0`：音頻處理
- `soundfile>=0.12.1`：音頻讀寫
- `numpy`：數值計算
- `torch`：深度學習框架

## 配置說明

### TTS 模型選擇

目前的載入策略：
- **預設模型**：`tts_models/multilingual/multi-dataset/xtts_v2`（支援多語言語音克隆與說話人適應）
- **備援模型**：`tts_models/multilingual/multi-dataset/xtts_v1`、`tts_models/multilingual/zh/glow-tts`
- **特性**：
  - 自動偵測 GPU，使用 `.to(device)` 切換裝置
  - 內建繁體中文（`zh-tw`）與英文語言映射
  - 若新版本 XTTS 無法載入，會自動降級至相容模型繼續服務

### GPU 支持

系統自動檢測 GPU 可用性：
- 如果可用 CUDA GPU，將使用 GPU 加速
- 否則自動回退到 CPU 模式

## 故障排查

### 問題 1：無法開始錄音
**原因**：麥克風設備不可用或驅動問題  
**解決方案**：
1. 檢查系統音頻設置
2. 確保麥克風正確連接
3. 測試麥克風在其他應用程序中是否工作

### 問題 2：克隆聲音效果不好
**原因**：參考音頻不清晰或過短  
**解決方案**：
1. 重新錄製，使用清晰的聲音
2. 確保錄製至少 2-3 秒
3. 避免背景噪音

### 問題 3：TTS 合成很慢
**原因**：使用 CPU 或 GPU 內存不足  
**解決方案**：
1. 如果可用，安裝 CUDA 驅動以使用 GPU
2. 關閉其他應用程序以釋放資源

### 問題 4：找不到 TTS 庫
**原因**：TTS 庫未安裝  
**解決方案**：
```bash
pip install TTS>=0.22.0
```

### 問題 5：初始化 TTS 模型失敗（錯誤訊息包含 `'zh'`）
**原因**：舊版模型不支援繁體中文語言代碼或設備設定異常。  
**解決方案**：
1. 系統會自動改用 XTTS v2 / v1，並將語言映射為 `zh-tw`
2. 若仍失敗，請確認已安裝最新版 `TTS` 套件，或手動刪除舊版模型快取後重試

## 性能考慮

- **首次運行**：TTS 模型下載和初始化可能需要 1-2 分鐘
- **合成時間**：根據文字長度和硬件，通常需要 2-10 秒
- **模型大小**：約 500MB（首次下載）

## 未來改進方向

1. 支持更多 TTS 模型選擇
2. 優化合成速度
3. 支持多個聲音混合
4. 聲音質量預視功能
5. 高級音訊處理選項

## 許可證

遵循項目主體許可證

## 技術支持

如遇到問題，請檢查：
1. `voice_clones/` 目錄是否正確創建
2. 參考音頻檔案是否存在且有效
3. 控制台輸出中的錯誤信息
4. 系統麥克風設置

---

**最後更新**: 2024年  
**版本**: 1.0.0
